---
title: "Intercluster 4Ws cleaning script"
date:  "23 March 2023"
output:
  html_document:
    code_download: yes
    theme: readable
    toc: yes
    toc_depth: 4
    toc_float: yes
    number_sections: no
    collapsed: no
always_allow_html: yes
---


```{r reading-4ws, warning=FALSE}

cash <- read_csv("./data/cbr_com.csv") %>% 
  filter(str_detect(cluster, "Multipurpose"))

fsl_tracker <- read_csv("./data/fsl_tracker.csv")

wash <- read_excel("./data/ocha_unedited/WASH OCHA2023_feb.xlsx",
                   sheet = 1) %>% 
  clean_names() %>% 
  rename(admin3pcode = sd_pcode, 
         admin4pcode = com_p_code, 
         admin5pcode = camp_pcode, 
         beneficiaries_in_location = number_benificiaries_in_the_location2, 
         camp_name = camp_asm_almkhym,
         school_name = schools_asm_lmdrst,
         collective_shelter_name = collective_shelter_asm_mrkz_alaywa_u_02be,
         health_facility_name = health_facility_name_asm_almnshat_altbyt, 
         water_system_name = name_of_water_system_asm_mhtt_almyah, 
         partner_code = ip_code,
         start_date = project_start_date, 
         end_date = project_end_date, 
         quarter = month, 
         month = iincluding_date, 
         project_status = status_alhalt, 
         governorate = gov) %>% 
  mutate(partner_code = ifelse(is.na(partner_code), ngo_code, partner_code), 
         cluster = "wash") %>% 
  left_join(locations %>%
              distinct(admin1pcode, admin2pcode, admin3pcode), 
            by = "admin3pcode") %>% 
  rename(construction_water_network = constuction_water_network, 
         fuel_consumption = fule_consumption, 
         construction_water_station = constuction_water_station, 
         cholera_wash_in_health =  cholera_was_hin_health, 
         reporting_month = reporting_month_shhr_altqryr, 
         total_usd = cash_total_money_usd) %>% 
  mutate(total_usd = as.numeric(total_usd))

cccm_names <- c("admin1pcode", "governorate",
                "admin2pcode","district",  
                "admin3pcode", "sub_district", 
                "admin4pcode", "community", 
                "is_2022", 
                "jan", "feb", "mar", "apr", 
                "may", "jun", "jul", "aug", 
                "sep", "oct", "nov", "dec", 
                "cumulative")

cccm <- rbind(
  read_excel(
    "./data/ocha_unedited/202302_CCCM 4Ws (as of February 2023).xlsx",
    sheet = "ISIMM_Assisted_IDPs",
    skip = 1) %>%
    setNames(cccm_names) %>% 
    mutate(activity = "ISIMM"),
  read_excel(
    "./data/ocha_unedited/202302_CCCM 4Ws (as of February 2023).xlsx",
    sheet = "CCCM_Activities_Assisted_IDPs",
    skip = 1) %>%
    setNames(cccm_names) %>% 
    mutate(activity = "CCCM")) %>% 
  mutate(jan = as.numeric(jan), 
         feb = as.numeric(feb),
         cluster = "CCCM")

shelter_select <- function(tbl){
  tbl %>% 
    select(sector, hub, response_modality, 
         # reporting_organisation = implementing_partner_name_or_code, 
         implementing_partner = final_implementing_partner_name_or_code, 
         governorate = governorate_mohafaza, 
         district = district_mantika, 
         sub_district = sub_district_nahya, 
         location, 
         location_type, 
         community = specific_location_name, 
         reporting_month, 
         start_date = activity_start_date_dd_mm_yyyy,
         end_date = activity_end_date_dd_mm_yyyy,
         project_status = status, 
         activity, 
         delivery_modality, 
         cash_conditionality,
         transfer_value = cash_transfer_voucher_value_per_household_usd, 
         cash_delivery_mechanism, 
         beneficiaries = total_number_individuals_reached, 
         families = total_number_of_families_h_hs_reached, 
         admin1pcode = admin1_pcode, 
         admin2pcode = admin2_pcode, 
         admin3pcode = admin3_pcode, 
         admin4pcode = location_pcode,
         new_beneficiaries = first_round_of_response_type_starting_2023)
}

snfi <- read_excel("./data/ocha_unedited/2023_WoS_SNFI_XBHub_4Ws_Jan&Feb2023.xlsx", 
           sheet = "Shelter 4Ws") %>% 
  clean_names() %>% 
  filter(!is.na(sector)) %>%  
  shelter_select() %>%
  mutate(sub_cluster = "shelter") %>% 
  filter(activity != "END_OF_FORMULA") %>%
  rbind(read_excel("./data/ocha_unedited/2023_WoS_SNFI_XBHub_4Ws_Jan&Feb2023.xlsx", 
           sheet = "NFI 4Ws") %>% 
          clean_names() %>% 
          filter(!is.na(sector)) %>% 
          shelter_select() %>% 
          mutate(sub_cluster = "nfi") %>% 
          filter(activity != "END_OF_FORMULA")) %>% 
  mutate(total_usd = transfer_value * families)

health_names <- read_excel("./data/ocha_unedited/Monthly Health Cluster Indicators Report GZT Jan-Feb 2023.xlsx", 
           sheet = 1) %>% 
  clean_names() %>% 
  transpose_df() %>% 
  select(rowname) %>% 
  mutate(rowname = str_replace_all(rowname,
  "number_of_|for_|supported_|between_levels_of_care_|received_|inside_syria_cross_line_and_cross_border_|inside_syria__cross_line_and_cross_border|attended_by_a_", ""), 
  rowname = str_replace_all(rowname, "consultations", "cons"), 
  rowname = str_replace_all(rowname, "rehabilitation_sessions", "rehab_sess")) %>%
  mutate(rowname = ifelse(nchar(rowname) > 75,
                          str_sub(rowname, start = 1L, end = 75L), 
                          rowname)) %>%
  pull(rowname)

health <- read_excel("./data/ocha_unedited/Monthly Health Cluster Indicators Report GZT Jan-Feb 2023.xlsx", 
           sheet = 1) %>% 
  setNames(health_names) %>% 
  pivot_longer(cols = 
                 (medical_procedures:
                    x3_1_6_community_health_workers_trained_re_trained_on_different_health_topi), 
               names_to = "activity", 
               values_to = "beneficiaries") %>% 
  rename(governorate = location_gov, 
         admin1pcode = code_governorate, 
         district = location_district, 
         admin2pcode = code_district, 
         sub_district = location_sub_district, 
         admin3pcode = code_sub_district, 
         community = location_community, 
         admin4pcode = code_community)

erl <- read_excel("./data/ocha_unedited/2023-02Feb_ERL_4Ws_NWS - WoS - V03 -WoS Validated.xlsx", 
           sheet = "4Ws") %>% 
  clean_names() %>% 
  rename(admin1pcode = admin1_pcode, 
         admin2pcode = admin2_pcode, 
         admin3pcode = admin3_pcode,
         admin4pcode = admin4_pcode,
         partner_code = implementing_partner, 
         beneficiaries = direct_beneficiaries, 
         previously_assisted = have_you_assisted_same_individual_during_previous_month, 
         conditionality = if_cash_cash_conditionality,
         restrictions = if_cash_cash_restriction, 
         cash_delivery_mechanism = if_cash_cash_delivery_mechanism,
         transfer_value = if_cash_cash_transfer_voucher_value_per_household_usd, 
         frequency = if_cash_cash_frequency) %>% 
  filter(indicator_unit == "People") %>% 
  mutate(total_usd = transfer_value * beneficiaries / 5)

fsl <- read_xlsb("./data/ocha_edited/FSL_January 2023_5Ws_OCHA_22032023.xlsb", 
           sheet = "5Ws Actuals - Jan 2023") %>% 
  clean_names() %>% 
  rename(admin1pcode = admin1_pcode_do_not_write, 
         admin2pcode = admin2_pcode_do_not_write, 
         admin3pcode = admin3_pcode_do_not_write, 
         admin4pcode = location_pcode_do_not_write, 
         admin5pcode = camp_pcode_do_not_write, 
         transfer_value = value, 
         reported_to_other_sector = has_this_data_been_reported_to_another_sector,
         beneficiaries = x_of_total_beneficiaries_assisted, 
         families = x_of_families_assisted, 
         start_date = starting_date, 
         end_date = ending_date,
         delivery_modality = delivery_modality_in_kind_service_cash_voucher, 
         activity = fss_activity_do_not_write, 
         frequency = monthly_frequency) %>% 
  # Crazy -- this is the first time I've seen the 1904 start date
  mutate_at(vars(start_date, end_date), ~ as.Date(as.numeric(.), origin = "1904-01-01")) %>% 
  mutate_at(vars(camp_name_cccm_official_name, 
                 camp_name_if_not_listed_by_the_cccm,
                 admin5pcode), ~ ifelse(. == "", NA_character_, .)) %>% 
  mutate(camp_name = ifelse(!is.na(camp_name_cccm_official_name), 
                            camp_name_cccm_official_name, 
                            camp_name_if_not_listed_by_the_cccm), 
         total_usd = frequency * transfer_value * families) 

edu_names <- read_excel("./data/ocha_unedited/Gaziantep 4Ws OCHA 2023 EDU.xlsx", 
           sheet = 5) %>% 
  head(1) %>% 
  transpose_df() %>% 
  select(rowname) %>% 
  mutate(rowname = gsub("\\p{Arabic}", "", rowname, perl = TRUE), 
         rowname = str_trim(str_replace_all(rowname, "\r\n", ""))) %>% 
  pull(rowname)


edu <- read_excel("./data/ocha_unedited/Gaziantep 4Ws OCHA 2023 EDU.xlsx", 
           sheet = 5) %>% 
  setNames(edu_names) %>% 
  clean_names() %>% 
  rename(admin1pcode = governorate_pcode, 
         admin2pcode = district_pcode, 
         admin3pcode = sub_district_pcode, 
         admin4pcode = community_pcode, 
         beneficiaries = total_new_individuals, 
         ben_frequencies = total_repeated_beneficiaries_reached, 
         camp_name = if_camp_please_select_the_name_of_the_camp_u_060c, 
         school_name = name_of_school_learning_center, 
         partner_code = implementing_partner_name_or_code)


nut <- read_excel("./data/ocha_unedited/NW Syria Nutrition cluster Jan + Feb 4Ws Dataset-Coded04042023.xlsx", 
           sheet = 1) %>% 
  clean_names() %>% 
  rename(admin1pcode = gov_pcode, 
         admin2pcode = dis_pcode, 
         admin3pcode = sub_dis_pcode, 
         admin4pcode = com_pcode,
         partner_code = organisation, 
         camp_name = camp,  
         health_facility_name = health_facility_or_rrt, 
         transfer_value = cash_transfer_voucher_value_usd) %>% 
  mutate(beneficiaries = male + female, 
         transfer_value = as.numeric(transfer_value), 
         frequency = as.numeric(frequency))


prot_names <- read_excel("./data/ocha_unedited/EXTERNAL_NWS_Complie_5Ws_2023_r1_v1_04042023.xlsx", 
           sheet = "Data entry sheet", 
           skip = 2) %>%
  head(1) %>% 
  transpose_df() %>%
  mutate(col_id = row_number()) %>% 
  mutate(rowname = gsub("\\p{Arabic}", "", rowname, perl = TRUE), 
         rowname = str_trim(str_replace_all(rowname, "\r\n|/|\\\\|\\*", ""))) %>% 
  mutate(rowname = case_when(col_id == 34 ~ "total_reached", 
                             col_id == 18 ~ "unit", 
                             col_id == 21 ~ "pwd",
                             col_id == 22 ~ "earthquake_response", 
                             col_id == 16 ~ "service_delivery",
                             TRUE ~ rowname)) %>% 
  pull(rowname)

prot <- read_excel("./data/ocha_unedited/EXTERNAL_NWS_Complie_5Ws_2023_r1_v1_04042023.xlsx", 
           sheet = "Data entry sheet", 
           skip = 2) %>%
  setNames(prot_names) %>% 
  clean_names() %>% 
  rename(admin1pcode = code_governorate, 
         admin2pcode = code_district, 
         admin3pcode = code_sub_district, 
         admin4pcode = code_commune_village_town, 
         admin5pcode = code_camps, 
         delivery_modality = delivery_modaity, 
         beneficiary_type = type_of_beneficiaries_only_if_unit_number_people, 
         total_achieved_as_per_unit = total_achieved_as_per_the_unit_in_the_previous_field, 
         hrp_project = hrp_project_or_not_yn_u_061f)

```

#### 6.2.1 Cash


```{r eval=FALSE, echo=TRUE}
# Total beneficiaries for cash
# Cash is lacking an ongoing option 
cash %>% 
  filter(project_status == "Completed" & 
           previously_assisted == "No") %>% 
  {sum(.$beneficiaries, na.rm = TRUE}

```

#### 6.2.2 FSL 

For food, there are distinct calculations for the cumulative figures reached and the monthly reached. 

<br>

```{r eval=FALSE, echo=TRUE}

# Total beneficiaries for food
# For monthly reached 
fsl %>% 
  mutate(month = case_when(reporting_month == "January" ~ "jan", 
                           TRUE ~ NA_character_)) %>% 
  filter(activity == "Food Baskets" & reported_to_other_sector == "No") %>% 
  group_by(final_implementing_partner, admin4pcode) %>% 
  slice(which.max(beneficiaries)) %>% 
  ungroup() %>% 
  group_by(month) %>% 
  summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE)) %>% 
  mutate(type = "food_cumulative")

# Cumulative beneficiaries for livelihoods
fsl %>% 
  mutate(month = case_when(reporting_month == "January" ~ "jan", 
                           TRUE ~ NA_character_)) %>% 
  filter(activity %in% c("Agricultural inputs",
                         "Animal treatment/vaccination",
                         "Income-generating activities (IGAs)", 
                         "Infrastructure rehabilitation",
                         "Livestock asset restoration") & 
           reported_to_other_sector == "No") %>% 
  group_by(final_implementing_partner, admin4pcode) %>% 
  slice(which.max(beneficiaries)) %>% 
  ungroup() %>% 
  group_by(month) %>% 
  summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE)) %>% 
  mutate(type = "livelihoods_cumulative")
  

```
<br>

#### 6.2.3 WASH

```{r}
wash %>% 
  filter(project_status == "Completed") %>% 
  group_by(health_facility_name, 
           school_name, 
           collective_shelter_name, 
           admin5pcode, 
           admin4pcode) %>%
  slice(which.max(so2)) %>% 
  ungroup() %>% 
  summarise(beneficiaries = sum(so2, na.rm = TRUE)) %>% 
  mutate(type = "wash_cumulative")
```

