colour = "% Reached",
size = "Frequencies")
com %>%
filter(activity != "ISIMM" & project_status %in% c("Completed", "Ongoing")) %>%
group_by(admin4pcode) %>%
summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE),
clusters = n_distinct(cluster), na.rm = TRUE) %>%
right_join(pop %>% select(total_pop, admin4pcode,
sub_district = admin3name_en,
admin3pcode,
governorate = admin1name_en,
community = location_name_en),
by = "admin4pcode") %>%
left_join(locations %>%
select(longitude_x, latitude_y, admin4pcode),
by = "admin4pcode") %>%
left_join(eq_score$data %>%
select(eq_score, admin4pcode),
by = "admin4pcode") %>%
mutate(total_pop = ifelse(beneficiaries > 0 & total_pop == 0,
beneficiaries,
total_pop)) %>%
filter(total_pop > 0) %>%
mutate(beneficiaries = ifelse(is.na(beneficiaries), 0, beneficiaries),
pc_reached = beneficiaries / total_pop,
pc_reached_scale = ifelse(pc_reached > 10, 10, pc_reached)) %>%
right_join(pcode3_shape,
by = c("admin3pcode" = "ADM3_PCODE")) %>%
filter(ADM1_PCODE %in% c("SY02", "SY07", "SY11") &
admin4pcode %in% (pop %>% pull(admin4pcode)) &
admin3pcode != "SY020500") %>%
st_as_sf() %>%
ggplot() +
geom_sf(size = .1, colour = "grey70") +
geom_point(aes(size = beneficiaries, colour = pc_reached_scale,
x = longitude_x, y = latitude_y,
text = paste0("sub_district: ", sub_district, "\n",
"community: ", community, "\n",
"admin4pcode: ", admin4pcode, "\n",
"population: ", format(total_pop, big.mark = ","), "\n",
"ben_freq: ", format(beneficiaries, big.mark = ","), "\n",
"clusters: ", clusters, "\n",
"%reached: ", round(pc_reached * 100, digits = 2), "%")),
alpha = .5) +
# setting NA value will not do anything if they won't even appear
scale_colour_viridis_c(option = "plasma", na.value = "grey25",
labels = percent) +
scale_size_continuous(labels = comma,
breaks = c(0, 100, 1000, 10000, 100000, 1000000, 2000000)) +
theme_void() +
theme(plot.background = element_rect(fill = "white", colour = NA)) +
labs(title = "Map of beneficiary frequencies",
colour = "% Reached",
size = "Frequencies")
com %>%
filter(activity != "ISIMM" & project_status %in% c("Completed", "Ongoing")) %>%
group_by(admin4pcode) %>%
summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE),
clusters = n_distinct(cluster), na.rm = TRUE) %>%
right_join(pop %>% select(total_pop, admin4pcode,
sub_district = admin3name_en,
admin3pcode,
governorate = admin1name_en,
community = location_name_en),
by = "admin4pcode") %>%
left_join(locations %>%
select(longitude_x, latitude_y, admin4pcode),
by = "admin4pcode") %>%
mutate(total_pop = ifelse(beneficiaries > 0 & total_pop == 0,
beneficiaries,
total_pop)) %>%
filter(total_pop > 0) %>%
mutate(beneficiaries = ifelse(beneficiaries == 0, NA_integer_, beneficiaries),
is_covered = ifelse(!is.na(beneficiaries), "Yes", "No")) %>%
filter(total_pop > 0) %>%
right_join(pcode3_shape,
by = c("admin3pcode" = "ADM3_PCODE")) %>%
filter(ADM1_PCODE %in% c("SY02", "SY07", "SY11") &
admin4pcode %in% (pop %>% pull(admin4pcode)) &
admin3pcode != "SY020500") %>%
st_as_sf() %>%
ggplot() +
geom_sf(size = .1, colour = "grey70") +
geom_point(aes(colour = is_covered, size = total_pop,
x = longitude_x, y = latitude_y),
alpha = .5) +
scale_colour_manual(values = c("#cc4778", "#0d0887")) +
scale_size_continuous(labels = comma,
breaks = c(100, 1000, 10000, 100000, 200000)) +
theme_void() +
theme(plot.background = element_rect(fill = "white", colour = NA)) +
labs(title = "Which communities have not been reached?",
subtitle = "Only shows whether a community has beneficiaries, not the percent reached",
colour = "Reached?",
size = "Population") +
# Why did it take me so many years to learn this?
guides(colour = guide_legend(order = 1),
size = guide_legend(order = 2))
com %>%
filter(activity != "ISIMM" & project_status %in% c("Completed", "Ongoing")) %>%
group_by(admin4pcode) %>%
summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE),
clusters = n_distinct(cluster), na.rm = TRUE) %>%
right_join(pop %>% select(total_pop, admin4pcode,
sub_district = admin3name_en,
admin3pcode,
governorate = admin1name_en,
community = location_name_en),
by = "admin4pcode") %>%
left_join(locations %>%
select(longitude_x, latitude_y, admin4pcode),
by = "admin4pcode") %>%
mutate(total_pop = ifelse(beneficiaries > 0 & total_pop == 0,
beneficiaries,
total_pop)) %>%
filter(total_pop > 0) %>%
mutate(beneficiaries = ifelse(beneficiaries == 0, NA_integer_, beneficiaries),
is_covered = ifelse(!is.na(beneficiaries), "Yes", "No")) %>%
filter(total_pop > 0) %>%
right_join(pcode3_shape,
by = c("admin3pcode" = "ADM3_PCODE")) %>%
filter(ADM1_PCODE %in% c("SY02", "SY07", "SY11") &
admin4pcode %in% (pop %>% pull(admin4pcode)) &
admin3pcode != "SY020500") %>%
st_as_sf() %>%
ggplot() +
geom_sf(size = .1, colour = "grey70") +
geom_point(aes(colour = is_covered, size = total_pop,
x = longitude_x, y = latitude_y),
alpha = .5) +
scale_colour_manual(values = c("#cc4778", "#0d0887")) +
scale_size_continuous(labels = comma,
breaks = c(1000, 10000, 50000, 100000, 200000)) +
theme_void() +
theme(plot.background = element_rect(fill = "white", colour = NA)) +
labs(title = "Which communities have not been reached?",
subtitle = "Only shows whether a community has beneficiaries, not the percent reached",
colour = "Reached?",
size = "Population") +
# Why did it take me so many years to learn this?
guides(colour = guide_legend(order = 1),
size = guide_legend(order = 2))
knitr::opts_chunk$set(echo = FALSE, fig.width=9, message = FALSE, warning=FALSE)
library(tidyverse)
library(readxl)
library(lubridate)
library(stringi)
library(janitor)
library(scales)
library(magrittr)
library(flextable)
library(ggrepel)
library(magrittr)
library(readxlsb)
library(widyr)
library(googlesheets4)
theme_set(theme_light())
# disabling scientific notation
options(scipen = 100)
`%out%` <- Negate(`%in%`)
# function for transposing df
transpose_df <- function(df) {
t_df <- data.table::transpose(df)
colnames(t_df) <- rownames(df)
rownames(t_df) <- colnames(df)
t_df <- t_df %>%
tibble::rownames_to_column(.data = .) %>%
tibble::as_tibble(.)
return(t_df)
}
# scaling functions
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}
#mode function
mode <- function(x) {
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
pcode3_shape <-
sf::st_read("./data/syr_admbnda_uncs_unocha_20201217/syr_admbnda_adm3_uncs_unocha_20201217.shp",
quiet = TRUE)
nw_pcode3 <- read_excel("./data/2023HNO_PiN_Severity_detailedAoI_FORSHARE 15032023.xlsx", skip = 1,
sheet = 1) %>%
clean_names() %>%
filter(ao_c == "NW") %>%
pull(admin3pcode)
locations <- read_excel("./data/Locations.xlsx") %>%
clean_names()
pop <- read_excel("./data/Population_Data_May_2022_final_01122022_with_SADD.xlsx",
sheet = 5,
skip = 2) %>%
clean_names() %>%
select(admin0name_en:longitude_x,
final_est_of_id_ps_may_2022:family_avg_size_total_pop) %>%
rename(idps = final_est_of_id_ps_may_2022,
total_pop = final_est_of_total_pop_may_2022,
avg_family_size = family_avg_size_total_pop)
names_eq <- c(
"date",
"governorate",
"district",
"sub_district",
"community",
"admin4",
"casualties",
"injuries",
"completely_destroyed_houses",
"damaged_unihabitable_houses",
"temporary_accommodation_centres",
"idps_in_all_centres",
"schools_as_accomodation_centres",
"idps_in_schools",
"tents_needed",
"blankets_mattresses_needed",
"temporary_accommodation_centres_available",
"accessible_civil_defense",
"latrines_available",
"meals_needed_per_day",
"need_blood_donations",
"health_services_available",
"necessary_medical_equipment",
"rubble_volunteers",
"telecoms_available",
"electricity_available",
"heating_fuel_needed"
)
eq <- read_excel("./data/syria-earthquake-impact-20-march-2023.xlsx",
sheet = "DATASET") %>%
setNames(names_eq)
fsl <- read_csv("./data/read/fsl.csv")
fsl %>% glimpse()
fsl %>%
mutate(project_status = ifelse(start_date < Sys.Date() & end_date > Sys.Date(),
"Ongoing",
"Completed"))
fsl %>%
mutate(project_status = ifelse(start_date < Sys.Date() & end_date > Sys.Date(),
"Ongoing",
"Completed")) %>%
count(project_status)
fsl %>%
mutate(project_status = case_when(start_date < Sys.Date() & end_date > Sys.Date() ~ "Ongoing",
end_date < Sys.Date() ~ "Completed",
start_date < Sys.Date() ~ "Planned",
# Just to catch the NAs, but FSL have their dates in order
TRUE ~ "Ongoing"))
fsl %>%
mutate(project_status = case_when(start_date < Sys.Date() & end_date > Sys.Date() ~ "Ongoing",
end_date < Sys.Date() ~ "Completed",
start_date < Sys.Date() ~ "Planned",
# Just to catch the NAs, but FSL have their dates in order
TRUE ~ "Ongoing")) %>%
count(project_status)
fsl %>%
mutate(project_status = case_when(start_date < Sys.Date() & end_date > Sys.Date() ~ "Ongoing",
end_date < Sys.Date() ~ "Completed",
start_date > Sys.Date() ~ "Planned",
# Just to catch the NAs, but FSL have their dates in order
TRUE ~ "Ongoing")) %>%
count(project_status)
fsl %>%
mutate(project_status = case_when(start_date < Sys.Date() & end_date > Sys.Date() ~ "Ongoing",
end_date < Sys.Date() ~ "Completed",
start_date > Sys.Date() ~ "Planned",
# Just to catch the NAs, but FSL have their dates in order
TRUE ~ "Ongoing")) %>%
filter(project_status == "Completed") %>%
head(10) %>%
select(start_date, end_date)
fsl %>%
mutate(project_status = case_when(start_date < Sys.Date() & end_date > Sys.Date() ~ "Ongoing",
end_date < Sys.Date() ~ "Completed",
start_date > Sys.Date() ~ "Planned",
# Just to catch the NAs, but FSL have their dates in order
TRUE ~ "Ongoing")) %>%
filter(project_status == "Ongoing") %>%
head(10) %>%
select(start_date, end_date)
fsl_clean <- function(tbl) {
tbl %>%
clean_names() %>%
rename(admin1pcode = admin1_pcode_do_not_write,
admin2pcode = admin2_pcode_do_not_write,
admin3pcode = admin3_pcode_do_not_write,
admin4pcode = location_pcode_do_not_write,
admin5pcode = camp_pcode_do_not_write,
transfer_value = value,
reported_to_other_sector = has_this_data_been_reported_to_another_sector,
beneficiaries = x_of_total_beneficiaries_assisted,
families = x_of_families_assisted,
start_date = starting_date,
end_date = ending_date,
delivery_modality = delivery_modality_in_kind_service_cash_voucher,
activity = fss_activity_do_not_write,
frequency = monthly_frequency) %>%
# Crazy -- this is the first time I've seen the 1904 start date
mutate_at(vars(start_date, end_date), ~ as.Date(as.numeric(.), origin = "1904-01-01")) %>%
mutate_at(vars(camp_name_cccm_official_name,
camp_name_if_not_listed_by_the_cccm,
admin5pcode), ~ ifelse(. == "", NA_character_, .)) %>%
mutate(camp_name = ifelse(!is.na(camp_name_cccm_official_name),
camp_name_cccm_official_name,
camp_name_if_not_listed_by_the_cccm),
total_usd = frequency * transfer_value * families) %>%
mutate(project_status = case_when(start_date < Sys.Date() & end_date > Sys.Date() ~ "Ongoing",
end_date < Sys.Date() ~ "Completed",
start_date > Sys.Date() ~ "Planned",
# Just to catch the NAs, but FSL have their dates in order
TRUE ~ "Ongoing"))
}
fsl <- rbind(
read_xlsb("./data/read/FSL_January 2023_5Ws_OCHA_22032023.xlsb",
sheet = "5Ws Actuals - Jan 2023") %>%
fsl_clean(),
read_xlsb("./data/read/FSL_February 2023_5Ws_OCHA_21042023.xlsb",
sheet = "5Ws Actuals - Feb 2023") %>%
fsl_clean(),
read_xlsb("./data/read/FSL_March 2023_5Ws_OCHA_17052023.xlsb",
sheet = "5Ws Actuals - Mar 2023") %>%
fsl_clean()
)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Ongoing") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Completed") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Completed") %>%
sample_n(10) %>%
select(start_date, end_date)
```{r}
fsl %>%
filter(project_status == "Completed") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Completed") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Planned") %>%
sample_n(10) %>%
select(start_date, end_date)
fsl %>%
filter(project_status == "Planned")
fsl %>% write_csv("./data/read/fsl.csv")
knitr::opts_chunk$set(echo = TRUE, fig.width=9, message = FALSE, warning=FALSE)
library(tidyverse)
library(readxl)
library(lubridate)
library(stringi)
library(pander)
library(janitor)
library(scales)
library(magrittr)
library(viridis)
library(patchwork)
library(sf)
library(plotly)
library(flextable)
library(ggrepel)
library(magrittr)
library(readxlsb)
library(tidymodels)
library(widyr)
library(googlesheets4)
theme_set(theme_light())
# disabling scientific notation
options(scipen = 100)
# replace
opts <- options(knitr.kable.NA = "")
`%out%` <- Negate(`%in%`)
# function for transposing df
transpose_df <- function(df) {
t_df <- data.table::transpose(df)
colnames(t_df) <- rownames(df)
rownames(t_df) <- colnames(df)
t_df <- t_df %>%
tibble::rownames_to_column(.data = .) %>%
tibble::as_tibble(.)
return(t_df)
}
# scaling functions
range01 <- function(x){(x-min(x))/(max(x)-min(x))}
range_wna <- function(x){(x-min(x, na.rm = TRUE))/(max(x, na.rm = TRUE)-min(x, na.rm = TRUE))}
#mode function
mode <- function(x) {
ux <- unique(x)
ux[which.max(tabulate(match(x, ux)))]
}
pcode3_shape <-
sf::st_read("./data/syr_admbnda_uncs_unocha_20201217/syr_admbnda_adm3_uncs_unocha_20201217.shp",
quiet = TRUE)
nw_pcode3 <- read_excel("./data/2023HNO_PiN_Severity_detailedAoI_FORSHARE 15032023.xlsx", skip = 1,
sheet = 1) %>%
clean_names() %>%
filter(ao_c == "NW") %>%
pull(admin3pcode)
locations <- read_excel("./data/Locations.xlsx") %>%
clean_names()
pop <- read_excel("./data/Population_Data_May_2022_final_01122022_with_SADD.xlsx",
sheet = 5,
skip = 2) %>%
clean_names() %>%
select(admin0name_en:longitude_x,
final_est_of_id_ps_may_2022:family_avg_size_total_pop) %>%
rename(idps = final_est_of_id_ps_may_2022,
total_pop = final_est_of_total_pop_may_2022,
avg_family_size = family_avg_size_total_pop)
consolidation_cols <- function(tbl) {
tbl %>%
select(admin1pcode, admin2pcode, admin3pcode, admin4pcode,
admin5pcode, camp_name,
activity, beneficiaries,
month, project_status, cluster,
delivery_modality,
transfer_value, total_usd)
}
fsl %>%
mutate(month = str_to_lower(str_sub(reporting_month, start = 1L, end = 3L))) %>%
filter(activity == "Food Baskets" & reported_to_other_sector == "No") %>%
group_by(final_implementing_partner, admin4pcode, month) %>%
slice(which.max(beneficiaries)) %>%
ungroup() %>%
group_by(month) %>%
summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE))
fsl %>%
mutate(month = str_to_lower(str_sub(reporting_month, start = 1L, end = 3L))) %>%
filter(activity == "Food Baskets" & reported_to_other_sector == "No") %>%
group_by(final_implementing_partner, admin4pcode, month) %>%
slice(which.max(beneficiaries)) %>%
ungroup() %>%
group_by(month) %>%
summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE)) %>%
summarise(beneficiaries = mean(beneficiaries, na.rm = TRUE)) %>%
mutate(type = "food_cumulative")
# Total beneficiaries for food
# For monthly reached
fsl %>%
mutate(month = str_to_lower(str_sub(reporting_month, start = 1L, end = 3L))) %>%
filter(activity == "Food Baskets" & reported_to_other_sector == "No") %>%
group_by(final_implementing_partner, admin4pcode, month) %>%
slice(which.max(beneficiaries)) %>%
ungroup() %>%
group_by(month) %>%
summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE)) %>%
mutate(type = "food_monthly")
# Total beneficiaries for food
# For monthly reached
fsl %>%
mutate(month = str_to_lower(str_sub(reporting_month, start = 1L, end = 3L))) %>%
filter(activity == "Food Baskets" & reported_to_other_sector == "No") %>%
group_by(final_implementing_partner, admin4pcode) %>%
slice(which.max(beneficiaries)) %>%
ungroup() %>%
group_by(month) %>%
summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE)) %>%
mutate(type = "food_monthly")
# Cumulative calculation for food beneficiaries
fsl %>%
mutate(month = str_to_lower(str_sub(reporting_month, start = 1L, end = 3L))) %>%
filter(activity == "Food Baskets" & reported_to_other_sector == "No") %>%
group_by(final_implementing_partner, admin4pcode) %>%
slice(which.max(beneficiaries)) %>%
ungroup() %>%
group_by(month) %>%
summarise(beneficiaries = sum(beneficiaries, na.rm = TRUE)) %>%
summarise(beneficiaries = mean(beneficiaries, na.rm = TRUE)) %>%
mutate(type = "food_cumulative")
